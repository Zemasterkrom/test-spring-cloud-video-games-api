name: Build and test with Load Balancing
on: push

jobs:
  build-test-lb-docker:
    name: ${{ matrix.os }} - Build and test with Load Balancing (Docker)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ macos-latest ]

    steps:
      - uses: actions/checkout@v3

      - name: Change default front server port
        shell: bash
        run: |
          echo $'\nFRONT_SERVER_PORT=4201' >> .env
          echo $'\nAPI_ALLOWED_ORIGINS=http://localhost:4201' >> .env
          echo $'\nLOADBALANCER_ALLOWED_ORIGINS=http://localhost:4201' >> .env

      - name: Optimize runners resources and timeout
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          echo $'\nlogging.level.root=ERROR\nserver.tomcat.max-threads=1' >> vglconfig/src/main/resources/application.properties
          echo $'\nlogging.level.root=ERROR\nserver.tomcat.max-threads=1' >> vgldiscovery/src/main/resources/application.properties
          echo $'\nlogging.level.root=ERROR\nserver.tomcat.max-threads=1' >> vglloadbalancer/src/main/resources/application.properties
          echo $'\nlogging.level.root=ERROR\nserver.tomcat.max-threads=1' >> vglservice/src/main/resources/application.properties

      - name: Install Docker on macOS
        if: runner.os == 'macOS'
        run: |
          mkdir -p ~/.docker/machine/cache
          curl -Lo ~/.docker/machine/cache/boot2docker.iso https://github.com/boot2docker/boot2docker/releases/download/v19.03.12/boot2docker.iso
          brew install docker docker-machine
          mkdir -p /etc/vbox && chmod -R +rwx /etc/vbox && echo $'\n* 10.0.0.0/8 192.168.0.0/16\n* 2001::/64' >> /etc/vbox/networks.conf
          sudo docker-machine create --driver virtualbox default
          sudo docker-machine env default

      #- name: Launch containers
      #  run: |
      #    GIT_CONFIG_BRANCH=${{github.head_ref || github.ref_name}} docker compose build vglconfig vglservice
      #    GIT_CONFIG_BRANCH=${{github.head_ref || github.ref_name}} docker compose build vgldiscovery vglloadbalancer
      #    GIT_CONFIG_BRANCH=${{github.head_ref || github.ref_name}} docker compose up -d --build

      - name: Test API and front
        uses: ./.github/actions/test-lb