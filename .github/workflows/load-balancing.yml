name: Build and test with Load Balancing
on: push

jobs:
  build-test-lb-docker:
    name: ${{ matrix.os }} - Build and test with Load Balancing (Docker)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ macos-latest ]

    steps:
      - uses: actions/checkout@v3

      - name: Install Docker on macOS
        if: runner.os == 'macOS'
        run: |

          sudo mkdir -p /etc/vbox
          sudo chmod -R 775 /etc/vbox
          echo '* 0.0.0.0/0 ::/0' > /etc/vbox/networks.conf

      #- name: Launch containers
      #  run: |
      #    GIT_CONFIG_BRANCH=${{github.head_ref || github.ref_name}} docker compose build vglconfig vglservice
      #    GIT_CONFIG_BRANCH=${{github.head_ref || github.ref_name}} docker compose build vgldiscovery vglloadbalancer
      #    GIT_CONFIG_BRANCH=${{github.head_ref || github.ref_name}} docker compose up -d --build

      - name: Test API and front
        uses: ./.github/actions/test-lb