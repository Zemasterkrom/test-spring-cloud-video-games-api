name: Build and test with Load Balancing
on: push

jobs:
  build-test-lb-docker:
    name: ${{ matrix.os }} - Build and test with Load Balancing (Docker)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ macos-latest ]

    steps:
      - uses: actions/checkout@v3

      - name: Install Docker on macOS
        if: runner.os == 'macOS'
        run: |
          # https://github.com/docker/for-mac/issues/2359#issuecomment-853420567
          brew install --cask docker
          # allow the app to run without confirmation
          xattr -d -r com.apple.quarantine /Applications/Docker.app
          
          # preemptively do docker.app's setup to avoid any gui prompts
          sudo /bin/cp /Applications/Docker.app/Contents/Library/LaunchServices/com.docker.vmnetd /Library/PrivilegedHelperTools
          
          # the plist we need used to be in /Applications/Docker.app/Contents/Resources, but
          # is now dynamically generated. So we dynamically generate our own
          sudo tee "/Library/LaunchDaemons/com.docker.vmnetd.plist" > /dev/null <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
          <key>Label</key>
          <string>com.docker.vmnetd</string>
          <key>Program</key>
          <string>/Library/PrivilegedHelperTools/com.docker.vmnetd</string>
          <key>ProgramArguments</key>
          <array>
          <string>/Library/PrivilegedHelperTools/com.docker.vmnetd</string>
          </array>
          <key>RunAtLoad</key>
          <true/>
          <key>Sockets</key>
          <dict>
          <key>Listener</key>
          <dict>
          <key>SockPathMode</key>
          <integer>438</integer>
          <key>SockPathName</key>
          <string>/var/run/com.docker.vmnetd.sock</string>
          </dict>
          </dict>
          <key>Version</key>
          <string>59</string>
          </dict>
          </plist>
          
          EOF
          
          sudo /bin/chmod 544 /Library/PrivilegedHelperTools/com.docker.vmnetd
          sudo /bin/chmod 644 /Library/LaunchDaemons/com.docker.vmnetd.plist
          sudo /bin/launchctl load /Library/LaunchDaemons/com.docker.vmnetd.plist
          
          sleep 5
          
          [[ $(uname) == 'Darwin' ]] || { echo "This function only runs on macOS." >&2; exit 2; }

          echo "-- Starting Docker.app, if necessary..."
          
          open -g -a Docker.app || exit
          
          # Wait for the server to start up, if applicable.
          i=0
          while ! docker system info &>/dev/null; do
          (( i++ == 0 )) && printf %s '-- Waiting for Docker to finish starting up...' || printf '.'
          sleep 1
          done
          (( i )) && printf '\n'
          
          echo "-- Docker is ready."

      - name: Launch containers
        run: |
          GIT_CONFIG_BRANCH=${{github.head_ref || github.ref_name}} docker compose build vglconfig vglservice
          GIT_CONFIG_BRANCH=${{github.head_ref || github.ref_name}} docker compose build vgldiscovery vglloadbalancer
          GIT_CONFIG_BRANCH=${{github.head_ref || github.ref_name}} docker compose up -d --build

      - name: Test API and front
        uses: ./.github/actions/test-lb